#!/bin/sh

if [ "$OVERTE" = "" ]; then
	        OVERTE=`realpath ../..`
fi
GITDATE=`git -C $OVERTE/source log -n 1 --format=raw | grep author | cut -d">" -f 2 | cut -d" " -f 2 | xargs -I {} date -d @{} +"%Y%m%d"`
GITCOMMIT=`git -C $OVERTE/source rev-parse HEAD | cut -c 1-7`
VERSION=${RPMVERSION}_${GITDATE}_${GITCOMMIT}

SOFILES=`ls \
		$OVERTE/build/libraries/*/*.so \
		$OVERTE/qt5-install/lib/libQt5Network.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Core.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Widgets.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Gui.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Script.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5WebSockets.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Qml.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Quick.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5ScriptTools.so.*.*.* \
	| sed 's/\./\\\./g' \
	| paste -d'|' -s`

DEPENDS=mesa-libGL,`ls \
		$OVERTE/build/assignment-client/assignment-client \
		$OVERTE/build/domain-server/domain-server \
		$OVERTE/build/tools/oven/oven \
		$OVERTE/build/libraries/*/*.so \
		$OVERTE/qt5-install/lib/libQt5Network.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Core.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Widgets.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Gui.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Script.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5WebSockets.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Qml.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5Quick.so.*.*.* \
		$OVERTE/qt5-install/lib/libQt5ScriptTools.so.*.*.* \
		$OVERTE/build/assignment-client/plugins/*.so \
		$OVERTE/build/assignment-client/plugins/*/*.so \
	| xargs -I {} sh -c 'objdump -p {} | grep NEEDED' \
	| awk '{print $2}' \
	| sort | uniq \
	| egrep -v "^($SOFILES)$" \
	| grep -v ^libGL \
	| xargs -I {} sh -c "ldconfig -p | grep {} | tr ' ' '\n' | grep /" \
	| xargs rpm -qf --queryformat "%{NAME}\n" \
	| sort | uniq \
	| paste -d',' -s`

sudo yum install chrpath

export VERSION DEPENDS OVERTE
rpmbuild --target x86_64 -bb ./overte-server.spec
mv ~/rpmbuild/RPMS/x86_64/*.rpm .
